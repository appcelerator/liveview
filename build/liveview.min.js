/*!
 * liveview Titanium CommonJS require with some Node.js love and dirty hacks
 * Copyright (c) 2013 Appcelerator
 */(function(globalScope){function Process(){if(!(this instanceof Process))return new Process;this.title="titanium",this.version="",this.moduleLoadList=[],this.versions={},this.arch=Ti.Platform.architecture,this.platform=Ti.Platform.osname,this.hardware=(""+Ti.Platform.model).replace("google_")}function Emitter(obj){if(obj)return mixin(obj)}function mixin(obj){for(var key in Emitter.prototype)obj[key]=Emitter.prototype[key];return obj}function Socket(opts){if(!(this instanceof Socket))return new Socket(opts);opts=opts||{},this.timeout=5e3,this.host=opts.host,this.port=opts.port,this.retry=opts.retry,this.bytesRead=0,this.bytesWritten=0,this.ignore=[]}function Module(id){this.filename=id+".js",this.id=id,this.exports={},this.loaded=!1}Process.prototype.__proto__=Emitter.prototype,Emitter.prototype.on=function(event,fn){return this._callbacks=this._callbacks||{},(this._callbacks[event]=this._callbacks[event]||[]).push(fn),this},Emitter.prototype.once=function(event,fn){function on(){self.off(event,on),fn.apply(this,arguments)}var self=this;return this._callbacks=this._callbacks||{},fn._off=on,this.on(event,on),this},Emitter.prototype.off=function(event,fn){this._callbacks=this._callbacks||{};var callbacks=this._callbacks[event];if(!callbacks)return this;if(1==arguments.length)return delete this._callbacks[event],this;var i=callbacks.indexOf(fn._off||fn);return~i&&callbacks.splice(i,1),this},Emitter.prototype.emit=function(event){this._callbacks=this._callbacks||{};var args=[].slice.call(arguments,1),callbacks=this._callbacks[event];if(callbacks){callbacks=callbacks.slice(0);for(var i=0,len=callbacks.length;i<len;++i)callbacks[i].apply(this,args)}return this},Emitter.prototype.listeners=function(event){return this._callbacks=this._callbacks||{},this._callbacks[event]||[]},Emitter.prototype.hasListeners=function(event){return!!this.listeners(event).length},typeof module!="undefined"&&(module.exports=Socket),Socket.prototype.__proto__=Emitter.prototype,Socket.prototype.connect=function(opts,fn){var self=this;opts=opts||{};var reConnect=!!opts.reConnect;"function"==typeof opts&&(fn=opts,opts={}),self.host=opts.host||self.host||"127.0.0.1",self.port=opts.port||self.port,self.retry=opts.retry||self.retry,this._proxy=Ti.Network.Socket.createTCP({host:self.host,port:self.port,connected:function(e){self.connected=!0,self._connection=e.socket,fn&&fn(e),self.emit(reConnect?"reconnect":"connect",e),Ti.Stream.pump(e.socket,function(e){if(e.bytesProcessed<0||!!e.errorStatus){self._proxy.close(),self.close(!0);return}self.emit("data",""+e.buffer)},1024,!0)},error:function(e){var err={code:e.errorCode,error:e.error};if(!~self.ignore.indexOf(err.code))return self.emit("error",err);self.emit("error ignored",err)}}),this._proxy.connect()},Socket.prototype.close=function(serverEnded){var self=this;self.connected=!1,self.closing=!serverEnded;if(self.closing){self.write(function(){self._proxy.close(),self.emit("close")});return}var retry=~~self.retry;self.emit("end");if(!retry)return;setTimeout(function(){self.emit("reconnecting"),self.connect({reConnect:!0})},retry)},Socket.prototype.write=function(data,fn){"function"==typeof data&&(fn=data,data=null),data=data?""+data:"";var msg=Ti.createBuffer({value:data}),callback=fn||function(){};Ti.Stream.write(this._connection,msg,function(){callback([].slice(arguments))})},Socket.prototype.setKeepAlive=function(enable,initialDelay){var self=this;if(!enable){self._keepAlive&&clearInterval(self._keepAlive),self._keepAlive=null;return}self._keepAlive=setInterval(function(){self.write("ping")},initialDelay||3e5)};var global=Module._global=Module.global={},process=global.process=Process();global.ENV="liveview",global.logging=!1,global.CATCH_ERRORS=!0,Module._cache={},Module._requireNative=function(){throw new Error("Module.patch must be run first")},Module._includeNative=function(){throw new Error("Module.patch must be run first")},Module.patch=function(globalCtx,url,port){var defaultURL=process.platform==="android"&&process.hardware==="sdk"?"10.0.2.2":"FSERVER_HOST";Module._globalCtx=globalCtx,global._globalCtx=globalCtx,Module._url=url||defaultURL,Module._port=port||8324,Module._requireNative=globalCtx.require,Module.evtServer&&Module.evtServer.close(),Ti.App.Properties.setBool("ti.android.bug2373.finishfalseroot",!1),globalCtx.localeStrings=Module.require("localeStrings"),globalCtx.L=function(name,filler){return(globalCtx.localeStrings[Ti.Locale.currentLanguage]||{})[name]||filler||name},Module.connectServer()},Module.global.reload=function(){try{Module.evtServer._proxy.close(),console.log("[LiveView] Reloading App"),Ti.App._restart()}catch(e){console.log("[LiveView] Reloading App via Legacy Method"),Module.require("app")}},Module.connectServer=function(){var retryInterval=null,client=Module.evtServer=new Socket({host:Module._url,port:8323},function(){console.log("[LiveView]","Connected to Event Server")});client.on("close",function(){console.log("[LiveView]","Closed Previous Event Server client")}),client.on("connect",function(){retryInterval&&(clearInterval(retryInterval),console.log("[LiveView]","Reconnected to Event Server"))}),client.on("data",function(data){if(!data)return;try{var evt=JSON.parse(""+data);evt.type==="event"&&evt.name==="reload"&&(Module._cache={},Module.global.reload())}catch(e){}}),client.on("end",function(){console.error("[LiveView]","Disconnected from Event Server"),retryInterval=setInterval(function(){console.log("[LiveView]","Attempting reconnect to Event Server"),client.connect()},2e3)}),client.on("error",function(e){var err=e.error,code=~~e.code;throw code===61&&(err="Event Server unavailable. Connection Refused @ "+Module._url+":"+Module._port+"\n[LiveView] Please ensure your device and computer are on the same network and the port is not blocked."),new Error("[LiveView] "+err)}),client.connect(),Module.require("app")},Module.include=function(ctx,id){var file=id.replace(".js",""),src=Module.prototype._getRemoteSource(file,1e4);eval.call(ctx,src)},Module.require=function(id){var fullPath=id,cached=Module.getCached(fullPath);if(!cached){var freshModule=new Module(fullPath);freshModule.cache(),freshModule._compile();while(!freshModule.loaded);return freshModule.exports}return cached.exports},Module.getCached=function(id){return Module._cache[id]},Module.exists=function(id){var path=Ti.Filesystem.resourcesDirectory+id+".js",file=Ti.Filesystem.getFile(path);return file.exists()},Module.prototype._getRemoteSource=function(file,timeout){var expireTime=(new Date).getTime()+timeout,request=Ti.Network.createHTTPClient(),rsp=null,file="http://"+Module._url+":"+Module._port+"/"+(file||this.id)+".js";request.cache=!1,request.open("GET",file),request.setRequestHeader("x-platform",process.platform),request.send();while(!rsp)if(request.readyState===4){if(request.status!==200)return rsp=!0,null;rsp=request.responseText}else if(expireTime-(new Date).getTime()<=0)throw rsp=!0,new Error("[LiveView] File Server unavailable. Host Unreachable @ "+Module._url+":"+Module._port+"\n[LiveView] Please ensure your device and computer are on the same network and the port is not blocked.");return rsp},Module.prototype._getSource=function(){var id=this.id,isRemote=/^(http|https)$/.test(id)||global.ENV==="liveview";if(isRemote)return this._getRemoteSource(null,1e4);id==="app"&&(id="_app");var file=Ti.Filesystem.getFile(Ti.Filesystem.resourcesDirectory,id+".js");return(file.read()||{}).text},Module._wrap=function(source){return source=source.replace(/T[i||itanium]+.include\([\'|\"]([^\"\'\r\n$]*)[\'|\"]\)/g,function(exp,val){var file=(""+val).replace(".js",""),_src=Module.prototype._getRemoteSource(file,1e4),evalSrc="try{ "+_src.replace(/\/\/(.*)$/gm,"").replace(/\n/g,"")+"}catch(err){ "+'lvGlobal.process.emit("uncaughtException", {module: "'+val+'", error: err})'+"}";return evalSrc}),global.CATCH_ERRORS?Module._errWrapper[0]+source+Module._errWrapper[1]:source},Module._errWrapper=["try {",'} catch (err) { lvGlobal.process.emit("uncaughtException", {module: __filename, error: err, source: module.source})}'],Module.prototype._compile=function(){var src=this._getSource();if(!src){this.exports=Module._requireNative(this.id),this.loaded=!0;return}this.source=Module._wrap(src);try{var fn=Function("exports, require, module, __filename, __dirname, lvGlobal",this.source);fn(this.exports,Module.require,this,this.filename,this.__dirname,global)}catch(err){process.emit("uncaughtException",{module:this.id,error:err,source:(""+this.source).split("\n")})}this.loaded=!0},Module.prototype.cache=function(){this.timestamp=(new Date).getTime(),Module._cache[this.id]=this},process.on("uncaughtException",function(err){console.log("[LiveView] Error Evaluating",err.module,"@ Line:",err.error.line),console.error(""+err.error),console.error("File:",err.module),console.error("Line:",err.error.line),console.error("SourceId:",err.error.sourceId),console.error("Backtrace:\n",(""+err.error.backtrace).replace(/'\n'/g,"\n"))}),Module.patch(globalScope)})(this);