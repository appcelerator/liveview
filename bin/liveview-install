#!/usr/bin/env node
'use strict';
const program = require('commander'),
	chalk = require('chalk'),
	path = require('path'),
	execSync = require('child_process').execSync,
	{ green, red, white, yellow } = chalk;

/**
 * no-op on unknown options handling
 */
program.Command.prototype.unknownOption = function () {};

// usage
program.usage('install');

// examples
program.on('--help', function () {
	console.log('  Examples:');
	console.log();
	console.log('    # install cli hook');
	console.log('    $ liveview install');
	console.log();
});

// parse argv
program.parse(process.argv);

if (!process.env.APPC_NPM_VERSION) {
	const hook = path.join(__dirname, '../hook').replace(/\s/g, '\\ ');
	try {
		const ticonf = JSON.parse(execSync('titanium config -o json').toString());
		if (ticonf['paths.hooks'].includes(hook)) {
			console.log(`${white('Titanium CLI Hook')} ${yellow('already installed')}`);
			process.exit(1);
		}
	} catch (e) {
		console.log(e);
		process.exit(1);
	}

	try {
		execSync('liveview server stop --no-banner',  { stdio: 'ignore' });
		execSync('titanium -q config paths.hooks -a ' + hook, { shell: true });
		console.log(` Titanium CLI Hook ${green('installed')}`);
	} catch (e) {
		console.log(e);
		console.log(` Titanium CLI Hook ${red('not installed')}`);
	}

}
