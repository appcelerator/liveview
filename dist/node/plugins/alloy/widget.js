"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.widgetPlugin = void 0;
const path_1 = __importDefault(require("path"));
/**
 * Plugin to support Alloy Widgets
 */
function widgetPlugin(appDir) {
    return {
        name: 'titanium:alloy:widgets',
        /**
         * Resolves URLs generated by `WPATH` to their source files inside a
         * Widget's `lib` directory.
         *
         * @todo: Support Widgets from `node_modules`.
         */
        async resolveId(id, importer) {
            if (id.startsWith('/') && !id.startsWith(appDir)) {
                // check WPATH generated url `/<widget>/<id>`
                const secondSlashIndex = id.indexOf('/', 1);
                if (secondSlashIndex !== -1) {
                    const widgetId = id.slice(1, secondSlashIndex);
                    const relativeId = id.slice(secondSlashIndex + 1);
                    const result = await this.resolve(path_1.default.join(appDir, 'widgets', widgetId, 'lib', relativeId), importer, { skipSelf: true });
                    if (result) {
                        return result.id;
                    }
                }
            }
        }
    };
}
exports.widgetPlugin = widgetPlugin;
